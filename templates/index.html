{% extends "layout.html" %}

{% block title %}Uyarılar - Telegram İzleme{% endblock %}

{% block content %}
<div class="col-md-12">
    <div class="page-header">
        <h3 class="page-title"><i class="bi bi-bell me-2"></i>Telegram Uyarıları</h3>
        <div class="actions-group">
            {% if not connected or not monitoring_active %}
            <form action="/start" method="post" class="d-inline">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-play-fill me-1"></i> İzlemeyi Başlat
                </button>
            </form>
            {% else %}
            <form action="/stop" method="post" class="d-inline">
                <button type="submit" class="btn btn-warning text-white">
                    <i class="bi bi-pause-fill me-1"></i> İzlemeyi Durdur
                </button>
            </form>
            {% endif %}
            <div class="dropdown d-inline">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="clearDropdownMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-trash me-1"></i> Temizle
                </button>
                <ul class="dropdown-menu" aria-labelledby="clearDropdownMenu">
                    <li>
                        <form action="/clear" method="post">
                            <input type="hidden" name="clear_type" value="filtered">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-funnel me-1"></i> Sadece Filtrelenmiş Uyarıları Temizle
                            </button>
                        </form>
                    </li>
                    <li>
                        <form action="/clear" method="post">
                            <input type="hidden" name="clear_type" value="unfiltered">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-chat me-1"></i> Sadece Filtrelenmemiş Mesajları Temizle
                            </button>
                        </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form action="/clear" method="post">
                            <input type="hidden" name="clear_type" value="all">
                            <button type="submit" class="dropdown-item text-danger">
                                <i class="bi bi-trash me-1"></i> Tüm Uyarıları Temizle
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle me-2"></i>{{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs mb-3" id="alertTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="filtered-tab" data-bs-toggle="tab" data-bs-target="#filtered-content" type="button" role="tab" aria-controls="filtered-content" aria-selected="true">
                <i class="bi bi-funnel-fill me-1"></i> Filtrelenmiş Uyarılar
                <span class="badge bg-primary ms-1 filtered-count">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="unfiltered-tab" data-bs-toggle="tab" data-bs-target="#unfiltered-content" type="button" role="tab" aria-controls="unfiltered-content" aria-selected="false">
                <i class="bi bi-chat-text me-1"></i> Tüm Mesajlar
                <span class="badge bg-secondary ms-1 unfiltered-count">0</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="alertTabsContent">
        <div class="tab-pane fade show active" id="filtered-content" role="tabpanel" aria-labelledby="filtered-tab">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex align-items-center">
                    <i class="bi bi-funnel me-2"></i> Filtreleme ve Arama
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Arama yapın...">
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                <select id="categoryFilter" class="form-select">
                                    <option value="">Tüm Kategoriler</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-chat"></i></span>
                                <select id="channelFilter" class="form-select">
                                    <option value="">Tüm Gruplar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" id="dateFilter" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <button id="clearFilters" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-x-circle me-1"></i> Filtreleri Temizle
                            </button>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <button id="exportAlerts" class="btn btn-success w-100">
                                <i class="bi bi-download me-1"></i> CSV Olarak İndir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-plus-circle me-2"></i> Manuel Uyarı Ekle
                    </div>
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#manualAlertFormContainer" aria-expanded="false" aria-controls="manualAlertFormContainer">
                        <i class="bi bi-chevron-down toggle-icon"></i>
                    </button>
                </div>
                <div class="collapse" id="manualAlertFormContainer">
                    <div class="card-body">
                        <form id="manualAlertForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="sender" class="form-label">Gönderen</label>
                                    <input type="text" class="form-control" id="sender" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="chat" class="form-label">Grup/Kanal</label>
                                    <input type="text" class="form-control" id="chat" required>
                                </div>
                                <div class="col-12">
                                    <label for="message" class="form-label">Mesaj</label>
                                    <textarea class="form-control" id="message" rows="3" required></textarea>
                                </div>
                                <div class="col-md-9">
                                    <label for="categories" class="form-label">Kategoriler (virgülle ayırın)</label>
                                    <input type="text" class="form-control" id="categories" required>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" id="important">
                                        <label class="form-check-label" for="important">Önemli</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus me-1"></i> Uyarı Ekle
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-funnel-fill me-2"></i> Filtrelenmiş Uyarılar
                    </div>
                    <span id="totalFilteredAlerts" class="badge bg-danger">0</span>
                </div>
                <div class="card-body p-3">
                    <div id="alertsLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <p class="mt-3 text-muted">Uyarılar yükleniyor...</p>
                    </div>
                    
                    <div id="alertsContainer" class="list-group" style="display: none;">
                        <div class="text-center py-5 text-muted" id="noAlertsMessage">
                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                            <h5>Henüz filtrelenmiş uyarı bulunmamaktadır</h5>
                            <p>İzleme başlatıldığında anahtar kelimeleri içeren mesajlar burada görünecektir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="unfiltered-content" role="tabpanel" aria-labelledby="unfiltered-tab">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex align-items-center">
                    <i class="bi bi-funnel me-2"></i> Filtreleme ve Arama
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="unfilteredSearchInput" class="form-control" placeholder="Arama yapın...">
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-chat"></i></span>
                                <select id="unfilteredChannelFilter" class="form-select">
                                    <option value="">Tüm Gruplar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" id="unfilteredDateFilter" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <button id="clearUnfilteredFilters" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-x-circle me-1"></i> Filtreleri Temizle
                            </button>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <button id="exportUnfilteredAlerts" class="btn btn-success w-100">
                                <i class="bi bi-download me-1"></i> CSV Olarak İndir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-chat-text me-2"></i> Tüm Mesajlar
                    </div>
                    <span id="totalUnfilteredAlerts" class="badge bg-secondary">0</span>
                </div>
                <div class="card-body p-3">
                    <div id="unfilteredAlertsLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <p class="mt-3 text-muted">Mesajlar yükleniyor...</p>
                    </div>
                    
                    <div id="unfilteredAlertsContainer" class="list-group" style="display: none;">
                        <div class="text-center py-5 text-muted" id="noUnfilteredAlertsMessage">
                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                            <h5>Henüz mesaj bulunmamaktadır</h5>
                            <p>İzleme başlatıldığında tüm mesajlar burada görünecektir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const alertsContainer = document.getElementById('alertsContainer');
        const alertsLoading = document.getElementById('alertsLoading');
        const totalFilteredAlertsElement = document.getElementById('totalFilteredAlerts');
        const noAlertsMessage = document.getElementById('noAlertsMessage');
        
        const unfilteredAlertsContainer = document.getElementById('unfilteredAlertsContainer');
        const unfilteredAlertsLoading = document.getElementById('unfilteredAlertsLoading');
        const totalUnfilteredAlertsElement = document.getElementById('totalUnfilteredAlerts');
        const noUnfilteredAlertsMessage = document.getElementById('noUnfilteredAlertsMessage');
        
        let totalFilteredAlerts = 0;
        let totalUnfilteredAlerts = 0;
        
        const filteredCountBadge = document.querySelector('.filtered-count');
        const unfilteredCountBadge = document.querySelector('.unfiltered-count');
        
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const channelFilter = document.getElementById('channelFilter');
        const dateFilter = document.getElementById('dateFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const exportAlertsBtn = document.getElementById('exportAlerts');
        
        const unfilteredSearchInput = document.getElementById('unfilteredSearchInput');
        const unfilteredChannelFilter = document.getElementById('unfilteredChannelFilter');
        const unfilteredDateFilter = document.getElementById('unfilteredDateFilter');
        const clearUnfilteredFiltersBtn = document.getElementById('clearUnfilteredFilters');
        const exportUnfilteredAlertsBtn = document.getElementById('exportUnfilteredAlerts');
        
        const collapseElement = document.getElementById('manualAlertFormContainer');
        collapseElement.addEventListener('show.bs.collapse', function () {
            document.querySelector('.toggle-icon').classList.remove('bi-chevron-down');
            document.querySelector('.toggle-icon').classList.add('bi-chevron-up');
        });

        collapseElement.addEventListener('hide.bs.collapse', function () {
            document.querySelector('.toggle-icon').classList.remove('bi-chevron-up');
            document.querySelector('.toggle-icon').classList.add('bi-chevron-down');
        });
        
        let allFilteredAlerts = [];
        let allUnfilteredAlerts = [];
        let categories = new Set();
        let filteredChannels = new Set();
        let unfilteredChannels = new Set();

        function loadFilteredAlerts() {
            fetch('/alerts?filter=filtered')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Filtrelenmiş uyarılar yüklenirken bir hata oluştu');
                    }
                    return response.json();
                })
                .then(data => {
                    alertsLoading.style.display = 'none';
                    alertsContainer.style.display = 'block';
                    
                    allFilteredAlerts = data;
                    
                    if (data.length > 0) {
                        noAlertsMessage.style.display = 'none';
                        
                        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        const existingAlerts = alertsContainer.querySelectorAll('.alert-card');
                        existingAlerts.forEach(el => el.remove());
                        
                        data.forEach(alert => {
                            addAlertToContainer(alert, false, alertsContainer);
                            
                            if (alert.categories) {
                                alert.categories.forEach(category => categories.add(category));
                            }
                            
                            if (alert.chat) {
                                filteredChannels.add(alert.chat);
                            }
                        });
                        
                        totalFilteredAlerts = data.length;
                        totalFilteredAlertsElement.textContent = totalFilteredAlerts;
                        filteredCountBadge.textContent = totalFilteredAlerts;
                        
                        updateCategoryFilter();
                        
                        updateChannelFilter(filteredChannels, channelFilter);
                        
                        setupFiltering();
                    } else {
                        noAlertsMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    alertsLoading.style.display = 'none';
                    alertsContainer.style.display = 'block';
                    
                    alertsContainer.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Hata:</strong> ${error.message || 'Uyarılar yüklenirken bir hata oluştu'}
                            <button class="btn btn-sm btn-outline-danger ms-3" onclick="location.reload()">Yeniden Dene</button>
                        </div>
                    `;
                });
        }
        
        function loadUnfilteredAlerts() {
            fetch('/alerts?filter=unfiltered')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Tüm mesajlar yüklenirken bir hata oluştu');
                    }
                    return response.json();
                })
                .then(data => {
                    unfilteredAlertsLoading.style.display = 'none';
                    unfilteredAlertsContainer.style.display = 'block';
                    
                    allUnfilteredAlerts = data;
                    
                    if (data.length > 0) {
                        noUnfilteredAlertsMessage.style.display = 'none';
                        
                        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        const existingAlerts = unfilteredAlertsContainer.querySelectorAll('.alert-card');
                        existingAlerts.forEach(el => el.remove());
                        
                        data.forEach(alert => {
                            addAlertToContainer(alert, false, unfilteredAlertsContainer);
                            
                            if (alert.chat) {
                                unfilteredChannels.add(alert.chat);
                            }
                        });
                        
                        totalUnfilteredAlerts = data.length;
                        totalUnfilteredAlertsElement.textContent = totalUnfilteredAlerts;
                        unfilteredCountBadge.textContent = totalUnfilteredAlerts;
                        
                        updateChannelFilter(unfilteredChannels, unfilteredChannelFilter);
                        
                        setupUnfilteredFiltering();
                    } else {
                        noUnfilteredAlertsMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    unfilteredAlertsLoading.style.display = 'none';
                    unfilteredAlertsContainer.style.display = 'block';
                    
                    unfilteredAlertsContainer.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Hata:</strong> ${error.message || 'Mesajlar yüklenirken bir hata oluştu'}
                            <button class="btn btn-sm btn-outline-danger ms-3" onclick="location.reload()">Yeniden Dene</button>
                        </div>
                    `;
                });
        }
        
        function updateAlertCounts() {
            fetch('/alert_counts')
                .then(response => response.json())
                .then(counts => {
                    totalFilteredAlerts = counts.filtered;
                    totalUnfilteredAlerts = counts.unfiltered;
                    
                    totalFilteredAlertsElement.textContent = totalFilteredAlerts;
                    totalUnfilteredAlertsElement.textContent = totalUnfilteredAlerts;
                    
                    filteredCountBadge.textContent = totalFilteredAlerts;
                    unfilteredCountBadge.textContent = totalUnfilteredAlerts;
                })
                .catch(error => console.error('Uyarı sayıları alınamadı:', error));
        }
        
        function updateCategoryFilter() {
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            
            const categoriesArray = Array.from(categories).sort();
            categoriesArray.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }
        
        function updateChannelFilter(channelsSet, filterElement) {
            while (filterElement.options.length > 1) {
                filterElement.remove(1);
            }
            
            const channelsArray = Array.from(channelsSet).sort();
            channelsArray.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                filterElement.appendChild(option);
            });
        }

        socket.on('new_alert', function(alert) {
            if (alert.filtered) {
                if (noAlertsMessage) {
                    noAlertsMessage.style.display = 'none';
                }
                
                addAlertToContainer(alert, true, alertsContainer);
                allFilteredAlerts.push(alert);
                
                if (alert.categories) {
                    alert.categories.forEach(category => {
                        categories.add(category);
                    });
                    updateCategoryFilter();
                }
                
                if (alert.chat) {
                    filteredChannels.add(alert.chat);
                    updateChannelFilter(filteredChannels, channelFilter);
                }
                
                totalFilteredAlerts++;
                totalFilteredAlertsElement.textContent = totalFilteredAlerts;
                filteredCountBadge.textContent = totalFilteredAlerts;
                
                if (document.getElementById('filtered-tab').classList.contains('active')) {
                    applyFilters();
                }
            } else {
                if (noUnfilteredAlertsMessage) {
                    noUnfilteredAlertsMessage.style.display = 'none';
                }
                
                addAlertToContainer(alert, true, unfilteredAlertsContainer);
                allUnfilteredAlerts.push(alert);
                
                if (alert.chat) {
                    unfilteredChannels.add(alert.chat);
                    updateChannelFilter(unfilteredChannels, unfilteredChannelFilter);
                }
                
                totalUnfilteredAlerts++;
                totalUnfilteredAlertsElement.textContent = totalUnfilteredAlerts;
                unfilteredCountBadge.textContent = totalUnfilteredAlerts;
                
                if (document.getElementById('unfiltered-tab').classList.contains('active')) {
                    applyUnfilteredFilters();
                }
            }
            
            if (Notification.permission === "granted") {
                const notificationTitle = alert.filtered ? 
                    "Yeni Telegram Uyarısı (Filtrelenmiş)" : 
                    "Yeni Telegram Mesajı";
                
                new Notification(notificationTitle, {
                    body: `${alert.chat}: ${alert.message.substring(0, 100)}...`,
                    icon: "/static/favicon.ico"
                });
            }
        });

        document.getElementById('manualAlertForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoriesStr = document.getElementById('categories').value;
            const categoriesArr = categoriesStr.split(',').map(cat => cat.trim()).filter(cat => cat);
            
            const alertData = {
                sender: document.getElementById('sender').value,
                chat: document.getElementById('chat').value,
                message: document.getElementById('message').value,
                categories: categoriesArr,
                filtered: categoriesArr.length > 0,
                important: document.getElementById('important').checked
            };
            
            fetch('/api/alerts/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(alertData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('manualAlertForm').reset();
                    
                    const bsCollapse = bootstrap.Collapse.getInstance(document.getElementById('manualAlertFormContainer'));
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                    
                    const successToast = document.createElement('div');
                    successToast.className = 'alert alert-success alert-dismissible fade show';
                    successToast.innerHTML = `
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Uyarı başarıyla eklendi!
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.page-header').insertAdjacentElement('afterend', successToast);
                    
                    setTimeout(() => {
                        successToast.remove();
                    }, 3000);
                } else {
                    alert('Hata: ' + data.error);
                }
            })
            .catch(error => {
                alert('Bir hata oluştu: ' + error);
            });
        });

        function setupFiltering() {
            const filters = [searchInput, categoryFilter, channelFilter, dateFilter];
            filters.forEach(filter => {
                filter.addEventListener('change', applyFilters);
                if (filter === searchInput) {
                    filter.addEventListener('keyup', applyFilters);
                }
            });
            
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                categoryFilter.value = '';
                channelFilter.value = '';
                dateFilter.value = '';
                applyFilters();
            });
            
            exportAlertsBtn.addEventListener('click', () => exportAlertsToCSV(allFilteredAlerts));
        }
        
        function setupUnfilteredFiltering() {
            const filters = [unfilteredSearchInput, unfilteredChannelFilter, unfilteredDateFilter];
            filters.forEach(filter => {
                filter.addEventListener('change', applyUnfilteredFilters);
                if (filter === unfilteredSearchInput) {
                    filter.addEventListener('keyup', applyUnfilteredFilters);
                }
            });
            
            clearUnfilteredFiltersBtn.addEventListener('click', () => {
                unfilteredSearchInput.value = '';
                unfilteredChannelFilter.value = '';
                unfilteredDateFilter.value = '';
                applyUnfilteredFilters();
            });
            
            exportUnfilteredAlertsBtn.addEventListener('click', () => exportAlertsToCSV(allUnfilteredAlerts));
        }
        
        function applyFilters() {
            const searchText = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedChannel = channelFilter.value;
            const selectedDate = dateFilter.value ? new Date(dateFilter.value) : null;
            
            const alertElements = alertsContainer.querySelectorAll('.alert-card');
            let visibleCount = 0;
            
            alertElements.forEach(alertEl => {
                const alertData = allFilteredAlerts.find(alert => alert.id === alertEl.dataset.id);
                
                if (!alertData) return;
                
                let show = true;
                
                if (searchText && !alertData.message.toLowerCase().includes(searchText)) {
                    show = false;
                }
                
                if (selectedCategory && (!alertData.categories || !alertData.categories.includes(selectedCategory))) {
                    show = false;
                }
                
                if (selectedChannel && alertData.chat !== selectedChannel) {
                    show = false;
                }
                
                if (selectedDate) {
                    const alertDate = new Date(alertData.timestamp);
                    const alertDateOnly = new Date(alertDate.getFullYear(), alertDate.getMonth(), alertDate.getDate());
                    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
                    
                    if (alertDateOnly.getTime() !== selectedDateOnly.getTime()) {
                        show = false;
                    }
                }
                
                alertEl.style.display = show ? '' : 'none';
                
                if (show) visibleCount++;
            });
            
            if (noAlertsMessage) {
                noAlertsMessage.style.display = visibleCount === 0 ? '' : 'none';
                if (visibleCount === 0 && alertElements.length > 0) {
                    noAlertsMessage.innerHTML = `
                        <i class="bi bi-search display-4 d-block mb-3"></i>
                        <h5>Filtreye uygun uyarı bulunamadı</h5>
                        <p>Lütfen filtrelerinizi değiştirin veya temizleyin.</p>
                    `;
                } else {
                    noAlertsMessage.innerHTML = `
                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                        <h5>Henüz filtrelenmiş uyarı bulunmamaktadır</h5>
                        <p>İzleme başlatıldığında anahtar kelimeleri içeren mesajlar burada görünecektir.</p>
                    `;
                }
            }
        }
        
        function applyUnfilteredFilters() {
            const searchText = unfilteredSearchInput.value.toLowerCase();
            const selectedChannel = unfilteredChannelFilter.value;
            const selectedDate = unfilteredDateFilter.value ? new Date(unfilteredDateFilter.value) : null;
            
            const alertElements = unfilteredAlertsContainer.querySelectorAll('.alert-card');
            let visibleCount = 0;
            
            alertElements.forEach(alertEl => {
                const alertData = allUnfilteredAlerts.find(alert => alert.id === alertEl.dataset.id);
                
                if (!alertData) return;
                
                let show = true;
                
                if (searchText && !alertData.message.toLowerCase().includes(searchText)) {
                    show = false;
                }
                
                if (selectedChannel && alertData.chat !== selectedChannel) {
                    show = false;
                }
                
                if (selectedDate) {
                    const alertDate = new Date(alertData.timestamp);
                    const alertDateOnly = new Date(alertDate.getFullYear(), alertDate.getMonth(), alertDate.getDate());
                    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
                    
                    if (alertDateOnly.getTime() !== selectedDateOnly.getTime()) {
                        show = false;
                    }
                }
                
                alertEl.style.display = show ? '' : 'none';
                
                if (show) visibleCount++;
            });
            
            if (noUnfilteredAlertsMessage) {
                noUnfilteredAlertsMessage.style.display = visibleCount === 0 ? '' : 'none';
                if (visibleCount === 0 && alertElements.length > 0) {
                    noUnfilteredAlertsMessage.innerHTML = `
                        <i class="bi bi-search display-4 d-block mb-3"></i>
                        <h5>Filtreye uygun mesaj bulunamadı</h5>
                        <p>Lütfen filtrelerinizi değiştirin veya temizleyin.</p>
                    `;
                } else {
                    noUnfilteredAlertsMessage.innerHTML = `
                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                        <h5>Henüz mesaj bulunmamaktadır</h5>
                        <p>İzleme başlatıldığında tüm mesajlar burada görünecektir.</p>
                    `;
                }
            }
        }
        
        function exportAlertsToCSV(alertsData) {
            
            if (alertsData.length === 0) {
                alert('Dışa aktarılacak veri bulunamadı.');
                return;
            }
            
            const csvData = [
                ['Tarih', 'Grup', 'Mesaj', 'Kategoriler', 'Filtrelenmiş', 'Okundu', 'Önemli', 'Notlar']
            ];
            
            alertsData.forEach(alert => {
                csvData.push([
                    alert.timestamp,
                    alert.chat,
                    alert.message.replace(/"/g, '""'),
                    alert.categories ? alert.categories.join(', ') : '',
                    alert.filtered ? 'Evet' : 'Hayır',
                    alert.read ? 'Evet' : 'Hayır',
                    alert.important ? 'Evet' : 'Hayır',
                    alert.notes ? alert.notes.replace(/"/g, '""') : ''
                ]);
            });
            
            const csvString = csvData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `telegram-alerts-${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const alertElement = document.createElement('div');
            alertElement.className = 'alert alert-success alert-dismissible fade show';
            alertElement.innerHTML = `
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>${alertsData.length}</strong> kayıt başarıyla dışa aktarıldı.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.page-header').insertAdjacentElement('afterend', alertElement);
            
            setTimeout(() => {
                alertElement.remove();
            }, 5000);
        }

        function addAlertToContainer(alert, isNew, container) {
            const alertElement = document.createElement('div');
            alertElement.className = `alert-card ${isNew ? 'new' : ''} ${alert.read ? 'alert-read' : ''} ${alert.important ? 'alert-important' : ''}`;
            alertElement.dataset.id = alert.id;
            
            const formattedDate = formatDateTime(alert.timestamp);
            
            const categoryBadges = alert.filtered && alert.categories && alert.categories.length > 0 ? 
                alert.categories.map(category => 
                    `<span class="badge bg-primary category-badge">${escapeHtml(category)}</span>`
                ).join('') : 
                '<span class="badge bg-secondary category-badge">Kategori Yok</span>';
            
            alertElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center">
                        <div class="alert-source">${escapeHtml(alert.chat)}</div>
                        ${alert.important ? '<span class="badge bg-danger ms-2"><i class="bi bi-star-fill"></i> Önemli</span>' : ''}
                        ${!alert.read ? '<span class="badge bg-primary ms-2"><i class="bi bi-envelope"></i> Yeni</span>' : ''}
                        ${alert.filtered ? '<span class="badge bg-success ms-2"><i class="bi bi-funnel-fill"></i></span>' : ''}
                    </div>
                    <div class="timestamp" title="${formattedDate.full}">${formattedDate.relative}</div>
                </div>
                <div class="message-container">
                    <div class="original-message my-2 text-break">${escapeHtml(alert.message)}</div>
                    <div class="translated-message my-2 text-break p-2 border-start border-4 border-primary" style="display: none;"></div>
                </div>
                <div class="mb-2">
                    ${categoryBadges}
                </div>
                ${alert.notes ? `
                <div class="alert alert-secondary p-2 mt-2 mb-2">
                    <small><i class="bi bi-card-text me-1"></i> <strong>Notlar:</strong> ${escapeHtml(alert.notes)}</small>
                </div>` : ''}
                <div class="d-flex justify-content-end alert-actions gap-2 mt-2">
                    <div class="dropdown d-inline">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle translate-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" title="Mesajı çevir">
                            <i class="bi bi-translate"></i> <span class="d-none d-md-inline">Çevir</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item translate-to" data-lang="en" href="#">İngilizce'ye Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="tr" href="#">Türkçe'ye Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="de" href="#">Almanca'ya Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="fr" href="#">Fransızca'ya Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="es" href="#">İspanyolca'ya Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="ru" href="#">Rusça'ya Çevir</a></li>
                            <li><a class="dropdown-item translate-to" data-lang="ar" href="#">Arapça'ya Çevir</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary toggle-notes-btn" data-bs-toggle="tooltip" title="${alert.notes ? 'Notu düzenle' : 'Not ekle'}">
                        <i class="bi bi-card-text"></i> <span class="d-none d-md-inline">${alert.notes ? 'Notu Düzenle' : 'Not Ekle'}</span>
                    </button>
                    <button class="btn btn-sm ${alert.important ? 'btn-danger' : 'btn-outline-danger'} toggle-important-btn" data-bs-toggle="tooltip" title="${alert.important ? 'Önemli işaretini kaldır' : 'Önemli olarak işaretle'}">
                        <i class="bi bi-star${alert.important ? '-fill' : ''}"></i>
                    </button>
                    <button class="btn btn-sm ${alert.read ? 'btn-success' : 'btn-outline-success'} toggle-read-btn" data-bs-toggle="tooltip" title="${alert.read ? 'Okunmadı olarak işaretle' : 'Okundu olarak işaretle'}">
                        <i class="bi bi-envelope${alert.read ? '-open-fill' : ''}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-alert-btn" data-bs-toggle="tooltip" title="Uyarıyı sil">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="notes-editor mt-2" style="display: none;">
                    <textarea class="form-control mb-2 notes-textarea" placeholder="Not eklemek için buraya yazın...">${alert.notes || ''}</textarea>
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-secondary cancel-notes-btn">
                            <i class="bi bi-x me-1"></i> İptal
                        </button>
                        <button class="btn btn-sm btn-success save-notes-btn">
                            <i class="bi bi-save me-1"></i> Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            if (container.firstChild && container.firstChild !== noAlertsMessage && container.firstChild !== noUnfilteredAlertsMessage) {
                container.insertBefore(alertElement, container.firstChild);
            } else {
                container.appendChild(alertElement);
            }
            
            if (isNew) {
                setTimeout(() => {
                    alertElement.classList.remove('new');
                }, 3000);
            }
            
            setupAlertButtons(alertElement, alert.filtered ? allFilteredAlerts : allUnfilteredAlerts);
            setupTranslationButtons(alertElement);
            
            const tooltips = alertElement.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(el => {
                new bootstrap.Tooltip(el);
            });
        }
        
        document.getElementById('filtered-tab').addEventListener('click', function() {
            loadFilteredAlerts();
        });
        
        document.getElementById('unfiltered-tab').addEventListener('click', function() {
            loadUnfilteredAlerts();
        });
        
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const fullDate = date.toLocaleDateString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let relativeDate;
            
            if (diffDays === 0) {
                relativeDate = date.toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (diffDays === 1) {
                relativeDate = 'Dün ' + date.toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (diffDays < 7) {
                const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                relativeDate = days[date.getDay()];
            } else {
                relativeDate = date.toLocaleDateString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }
            
            return {
                full: fullDate,
                relative: relativeDate
            };
        }
        
        function setupTranslationButtons(alertElement) {
            const alertId = alertElement.dataset.id;
            const messageText = alertElement.querySelector('.original-message').textContent;
            const translatedContainer = alertElement.querySelector('.translated-message');
            
            const translateButtons = alertElement.querySelectorAll('.translate-to');
            translateButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const targetLang = button.dataset.lang;
                    
                    translatedContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Çevriliyor...</span></div> Çevriliyor...';
                    translatedContainer.style.display = 'block';
                    
                    try {
                        const translatedText = await translateText(messageText, targetLang);
                        
                        translatedContainer.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted"><i class="bi bi-translate me-1"></i> ${getLanguageName(targetLang)}'ye çevrildi</small>
                                <button class="btn btn-sm btn-link hide-translation p-0">
                                    <i class="bi bi-x-lg"></i> Çeviriyi Gizle
                                </button>
                            </div>
                            ${escapeHtml(translatedText)}
                        `;
                        
                        const hideBtn = translatedContainer.querySelector('.hide-translation');
                        hideBtn.addEventListener('click', () => {
                            translatedContainer.style.display = 'none';
                        });
                        
                        let foundAlert = allFilteredAlerts.find(a => a.id === alertId);
                        if (foundAlert) {
                            foundAlert.translatedText = translatedText;
                            foundAlert.translatedLang = targetLang;
                        } else {
                            foundAlert = allUnfilteredAlerts.find(a => a.id === alertId);
                            if (foundAlert) {
                                foundAlert.translatedText = translatedText;
                                foundAlert.translatedLang = targetLang;
                            }
                        }
                    } catch (error) {
                        translatedContainer.innerHTML = `
                            <div class="alert alert-danger p-2 m-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <small>Çeviri yapılırken bir hata oluştu: ${error.message}</small>
                                <button class="btn btn-sm btn-link hide-translation p-0 float-end">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        `;
                        
                        const hideBtn = translatedContainer.querySelector('.hide-translation');
                        hideBtn.addEventListener('click', () => {
                            translatedContainer.style.display = 'none';
                        });
                        
                        console.error('Translation error:', error);
                    }
                });
            });
        }
        
        function getLanguageName(langCode) {
            const languages = {
                'en': 'İngilizce',
                'tr': 'Türkçe',
                'de': 'Almanca',
                'fr': 'Fransızca',
                'es': 'İspanyolca',
                'ru': 'Rusça',
                'ar': 'Arapça'
            };
            return languages[langCode] || langCode;
        }
        
        async function translateText(text, targetLang) {
            const apiUrl = '/api/translate';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        targetLang: targetLang
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Çeviri servisine erişilemiyor');
                }
                
                const data = await response.json();
                return data.translatedText;
            } catch (error) {
                console.error('Translation API error:', error);
                throw new Error('Çeviri yapılırken bir hata oluştu');
            }
        }
        
        function setupAlertButtons(alertElement, alertsCollection) {
            const alertId = alertElement.dataset.id;
            
            const readBtn = alertElement.querySelector('.toggle-read-btn');
            readBtn.addEventListener('click', () => {
                const isRead = alertElement.classList.contains('alert-read');
                
                alertElement.classList.toggle('alert-read');
                const badgeEl = alertElement.querySelector('.badge.bg-primary:not(.category-badge)');
                if (isRead && badgeEl) {
                    badgeEl.remove();
                } else if (!isRead) {
                    const sourceEl = alertElement.querySelector('.alert-source');
                    sourceEl.insertAdjacentHTML('afterend', '<span class="badge bg-primary ms-2"><i class="bi bi-envelope"></i> Yeni</span>');
                }
                readBtn.classList.toggle('btn-outline-success');
                readBtn.classList.toggle('btn-success');
                readBtn.innerHTML = isRead ? '<i class="bi bi-envelope"></i>' : '<i class="bi bi-envelope-open-fill"></i>';
                readBtn.setAttribute('title', isRead ? 'Okundu olarak işaretle' : 'Okunmadı olarak işaretle');
                
                const tooltip = bootstrap.Tooltip.getInstance(readBtn);
                if (tooltip) {
                    tooltip.dispose();
                }
                new bootstrap.Tooltip(readBtn);
                
                const alertData = alertsCollection.find(a => a.id === alertId);
                if (alertData) {
                    alertData.read = !isRead;
                }
                
                fetch(`/api/alerts/${alertId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ read: !isRead })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('İşlem başarısız');
                    }
                    return response.json();
                })
                .catch(error => {
                    alertElement.classList.toggle('alert-read');
                    if (isRead) {
                        const sourceEl = alertElement.querySelector('.alert-source');
                        sourceEl.insertAdjacentHTML('afterend', '<span class="badge bg-primary ms-2"><i class="bi bi-envelope"></i> Yeni</span>');
                    } else if (badgeEl) {
                        badgeEl.remove();
                    }
                    readBtn.classList.toggle('btn-outline-success');
                    readBtn.classList.toggle('btn-success');
                    readBtn.innerHTML = isRead ? '<i class="bi bi-envelope-open-fill"></i>' : '<i class="bi bi-envelope"></i>';
                    
                    if (alertData) {
                        alertData.read = isRead;
                    }
                    
                    const errorToast = document.createElement('div');
                    errorToast.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                    errorToast.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Hata:</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(errorToast);
                    
                    setTimeout(() => {
                        errorToast.remove();
                    }, 5000);
                });
            });
            
            const importantBtn = alertElement.querySelector('.toggle-important-btn');
            importantBtn.addEventListener('click', () => {
                const isImportant = alertElement.classList.contains('alert-important');
                
                alertElement.classList.toggle('alert-important');
                const badgeEl = alertElement.querySelector('.badge.bg-danger');
                if (isImportant && badgeEl) {
                    badgeEl.remove();
                } else if (!isImportant) {
                    const sourceEl = alertElement.querySelector('.alert-source');
                    sourceEl.insertAdjacentHTML('afterend', '<span class="badge bg-danger ms-2"><i class="bi bi-star-fill"></i> Önemli</span>');
                }
                importantBtn.classList.toggle('btn-outline-danger');
                importantBtn.classList.toggle('btn-danger');
                importantBtn.innerHTML = isImportant ? '<i class="bi bi-star"></i>' : '<i class="bi bi-star-fill"></i>';
                importantBtn.setAttribute('title', isImportant ? 'Önemli olarak işaretle' : 'Önemli işaretini kaldır');
                
                const tooltip = bootstrap.Tooltip.getInstance(importantBtn);
                if (tooltip) {
                    tooltip.dispose();
                }
                new bootstrap.Tooltip(importantBtn);
                
                const alertData = alertsCollection.find(a => a.id === alertId);
                if (alertData) {
                    alertData.important = !isImportant;
                }
                
                fetch(`/api/alerts/${alertId}/important`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ important: !isImportant })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('İşlem başarısız');
                    }
                    return response.json();
                })
                .catch(error => {
                    alertElement.classList.toggle('alert-important');
                    if (isImportant) {
                        const sourceEl = alertElement.querySelector('.alert-source');
                        sourceEl.insertAdjacentHTML('afterend', '<span class="badge bg-danger ms-2"><i class="bi bi-star-fill"></i> Önemli</span>');
                    } else if (badgeEl) {
                        badgeEl.remove();
                    }
                    importantBtn.classList.toggle('btn-outline-danger');
                    importantBtn.classList.toggle('btn-danger');
                    importantBtn.innerHTML = isImportant ? '<i class="bi bi-star-fill"></i>' : '<i class="bi bi-star"></i>';
                    
                    if (alertData) {
                        alertData.important = isImportant;
                    }
                    
                    const errorToast = document.createElement('div');
                    errorToast.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                    errorToast.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Hata:</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(errorToast);
                    
                    setTimeout(() => {
                        errorToast.remove();
                    }, 5000);
                });
            });
            
            const deleteBtn = alertElement.querySelector('.delete-alert-btn');
            deleteBtn.addEventListener('click', () => {
                if (confirm('Bu uyarıyı silmek istediğinizden emin misiniz?')) {
                    alertElement.style.opacity = '0.5';
                    alertElement.style.pointerEvents = 'none';
                    
                    fetch(`/api/alerts/${alertId}/delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Silme işlemi başarısız');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alertElement.remove();
                            
                            const isFiltered = alertsCollection === allFilteredAlerts;
                            
                            if (isFiltered) {
                                totalFilteredAlerts--;
                                totalFilteredAlertsElement.textContent = totalFilteredAlerts;
                                filteredCountBadge.textContent = totalFilteredAlerts;
                                
                                allFilteredAlerts = allFilteredAlerts.filter(a => a.id !== alertId);
                                
                                if (totalFilteredAlerts === 0 && noAlertsMessage) {
                                    noAlertsMessage.style.display = '';
                                }
                            } else {
                                totalUnfilteredAlerts--;
                                totalUnfilteredAlertsElement.textContent = totalUnfilteredAlerts;
                                unfilteredCountBadge.textContent = totalUnfilteredAlerts;
                                
                                allUnfilteredAlerts = allUnfilteredAlerts.filter(a => a.id !== alertId);
                                
                                if (totalUnfilteredAlerts === 0 && noUnfilteredAlertsMessage) {
                                    noUnfilteredAlertsMessage.style.display = '';
                                }
                            }
                            
                            updateAlertCounts();
                        } else {
                            throw new Error('Silme işlemi başarısız');
                        }
                    })
                    .catch(error => {
                        alertElement.style.opacity = '';
                        alertElement.style.pointerEvents = '';
                        
                        const errorToast = document.createElement('div');
                        errorToast.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                        errorToast.innerHTML = `
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Hata:</strong> ${error.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.body.appendChild(errorToast);
                        
                        setTimeout(() => {
                            errorToast.remove();
                        }, 5000);
                    });
                }
            });
            
            const toggleNotesBtn = alertElement.querySelector('.toggle-notes-btn');
            const notesEditor = alertElement.querySelector('.notes-editor');
            const cancelNotesBtn = alertElement.querySelector('.cancel-notes-btn');
            const saveNotesBtn = alertElement.querySelector('.save-notes-btn');
            const notesTextarea = alertElement.querySelector('.notes-textarea');
            
            toggleNotesBtn.addEventListener('click', () => {
                notesEditor.style.display = notesEditor.style.display === 'none' ? 'block' : 'none';
                if (notesEditor.style.display === 'block') {
                    notesTextarea.focus();
                }
            });
            
            cancelNotesBtn.addEventListener('click', () => {
                notesEditor.style.display = 'none';
                const alertData = alertsCollection.find(a => a.id === alertId);
                notesTextarea.value = alertData?.notes || '';
            });
            
            saveNotesBtn.addEventListener('click', () => {
                const notes = notesTextarea.value.trim();
                const alertData = alertsCollection.find(a => a.id === alertId);
                const originalNotes = alertData?.notes || '';
                
                if (notes === originalNotes) {
                    notesEditor.style.display = 'none';
                    return;
                }
                
                const btnText = saveNotesBtn.innerHTML;
                saveNotesBtn.disabled = true;
                saveNotesBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                
                const notesDisplay = alertElement.querySelector('.alert.alert-secondary');
                
                if (notes) {
                    if (notesDisplay) {
                        notesDisplay.innerHTML = `<small><i class="bi bi-card-text me-1"></i> <strong>Notlar:</strong> ${escapeHtml(notes)}</small>`;
                    } else {
                        const categoriesDiv = alertElement.querySelector('.mb-2:not(.text-break)');
                        categoriesDiv.insertAdjacentHTML('afterend', `
                            <div class="alert alert-secondary p-2 mt-2 mb-2">
                                <small><i class="bi bi-card-text me-1"></i> <strong>Notlar:</strong> ${escapeHtml(notes)}</small>
                            </div>
                        `);
                    }
                    toggleNotesBtn.innerHTML = '<i class="bi bi-card-text"></i> <span class="d-none d-md-inline">Notu Düzenle</span>';
                    toggleNotesBtn.setAttribute('title', 'Notu düzenle');
                } else {
                    if (notesDisplay) {
                        notesDisplay.remove();
                    }
                    toggleNotesBtn.innerHTML = '<i class="bi bi-card-text"></i> <span class="d-none d-md-inline">Not Ekle</span>';
                    toggleNotesBtn.setAttribute('title', 'Not ekle');
                }
                
                const tooltip = bootstrap.Tooltip.getInstance(toggleNotesBtn);
                if (tooltip) {
                    tooltip.dispose();
                }
                new bootstrap.Tooltip(toggleNotesBtn);
                
                if (alertData) {
                    alertData.notes = notes;
                }
                
                fetch(`/api/alerts/${alertId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ notes: notes })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Not kaydetme işlemi başarısız');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        notesEditor.style.display = 'none';
                        
                        const successToast = document.createElement('div');
                        successToast.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                        successToast.style.zIndex = '9999';
                        successToast.innerHTML = `
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Not başarıyla kaydedildi
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.body.appendChild(successToast);
                        
                        setTimeout(() => {
                            successToast.remove();
                        }, 3000);
                    } else {
                        throw new Error('Not kaydetme işlemi başarısız');
                    }
                })
                .catch(error => {
                    if (originalNotes) {
                        if (notesDisplay) {
                            notesDisplay.innerHTML = `<small><i class="bi bi-card-text me-1"></i> <strong>Notlar:</strong> ${escapeHtml(originalNotes)}</small>`;
                        } else {
                            const categoriesDiv = alertElement.querySelector('.mb-2:not(.text-break)');
                            categoriesDiv.insertAdjacentHTML('afterend', `
                                <div class="alert alert-secondary p-2 mt-2 mb-2">
                                    <small><i class="bi bi-card-text me-1"></i> <strong>Notlar:</strong> ${escapeHtml(originalNotes)}</small>
                                </div>
                            `);
                        }
                        toggleNotesBtn.innerHTML = '<i class="bi bi-card-text"></i> <span class="d-none d-md-inline">Notu Düzenle</span>';
                    } else {
                        if (notesDisplay) {
                            notesDisplay.remove();
                        }
                        toggleNotesBtn.innerHTML = '<i class="bi bi-card-text"></i> <span class="d-none d-md-inline">Not Ekle</span>';
                    }
                    
                    if (alertData) {
                        alertData.notes = originalNotes;
                    }
                    
                    notesTextarea.value = originalNotes;
                    
                    const errorToast = document.createElement('div');
                    errorToast.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                    errorToast.style.zIndex = '9999';
                    errorToast.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Hata:</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(errorToast);
                    
                    setTimeout(() => {
                        errorToast.remove();
                    }, 5000);
                })
                .finally(() => {
                    saveNotesBtn.disabled = false;
                    saveNotesBtn.innerHTML = btnText;
                });
            });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    const successToast = document.createElement('div');
                    successToast.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                    successToast.innerHTML = `
                        <i class="bi bi-bell-fill me-2"></i>
                        Bildirim izni verildi. Yeni uyarılar için bildirim alacaksınız.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(successToast);
                    
                    setTimeout(() => {
                        successToast.remove();
                    }, 5000);
                }
            });
        }
        
        loadFilteredAlerts();
        updateAlertCounts();
    });
</script>
{% endblock %}